U0 = 50; Y0 = 41.18;
u(1:100) = 0;
u(101:1000) = 0;
y(1:1000) = 0;
yzad(1:1000) = 0;


% z pliku dmc:
Kuj = [ 
    0.110767717394644	0.113164839563703	0.115547375615885	0.117913338000950	0.120261054455262	0.122589125375989	0.124896386878188	0.127181878778138	0.129444816847014	0.131684568766345	0.133900633292333	0.136092622201776	0.138260244649195	0.140403293614085	0.142521634159936	0.144615193263754	0.146683951006910	0.148727932945995	0.150477519571521	0.151716155479731	0.152515447092769	0.152937422144636	0.153035805413575	0.152857124618559	0.152441669088916	0.151824320806333	0.151035274809383	0.150100663688980	0.149043098942459	0.147882140254335	0.146634702298391	0.145315407378464	0.143936891118094	0.142510067449358	0.141044358319154	0.139547892809906	0.138027679746390	0.136489757318354	0.134939322778721	0.133380844869828	0.131818161277070	0.130254563103213	0.128692868091280	0.127135484093919	0.125584464087718	0.124041553858114	0.122508233330667	0.120985752394586	0.119475161951782	0.117977340827104	0.116493019090807	0.115022798270921	0.113567168869621	0.112126525542561	0.110701180252350	0.109291373665922	0.107897285029649	0.106519040724895	0.105156721679750	0.103810369789269	0.102479993476266	0.101165572507142	0.0998670621619738	0.0985843968448878	0.0973174932092885	0.0960662528625831	0.0948305647064377	0.0936103069611427	0.0924053489161931	0.0912155524435884	0.0900407733054919	0.0888808622836805	0.0877356661545607	0.0866050285303626	0.0854887905843786	0.0843867916757339	0.0832988698871135	0.0822248624870851	0.0811646063271024	0.0801179381819349	0.0790846950411029	0.0780647143578873	0.0770578342616086	0.0760638937381120	0.0750827327827345	0.0741141925294653	0.0731581153595109	0.0722143449920503	0.0712827265595968	0.0703631066700562	0.0694553334572948	0.0685592566217896	0.0676747274627213	0.0668015989026902	0.0659397255060760	0.0650889634919290	0.0642491707421589	0.0634202068056846	0.0626019328991229	0.0617942119045126	0.0609969083645063	0.0602098884754043	0.0594330200783527	0.0586661726489863	0.0579092172857594	0.0571620266971720	0.0564244751880746	0.0556964386452069	0.0549777945221064	0.0542684218235034	0.0535682010893035	0.0528770143782446	0.0521947452513035	0.0515212787549167	0.0508565014040710	0.0502003011653116	0.0495525674397091	0.0489131910458206	0.0482820642026742	0.0476590805128044	0.0470441349453584	0.0464371238192931	0.0458379447866783	0.0452464968161199	0.0446626801763134	0.0440863964197377	0.0435175483664972	0.0429560400883177	0.0424017768927026	0.0418546653072518	0.0413146130641491	0.0407815290848179	0.0402553234647493	0.0397359074585023	0.0392231934648778	0.0387170950122676	0.0382175267441757	0.0377244044049150	0.0372376448254766	0.0367571659095717	0.0362828866198454	0.0358147269642609	0.0353526079826531	0.0348964517334499	0.0344461812805608	0.0340017206804296	0.0335629949692513	0.0331299301503504	0.0327024531817196	0.0322804919637171	0.0318615255136449	0.0314455049577867	0.0310323819203371	0.0306221085154218	0.0302146373392266	0.0298099214622362	0.0294079144215876	0.0290085702135408	0.0286118432860737	0.0282176885316051	0.0278260612798547	0.0274369172908477	0.0270502127480734	0.0266659042518095	0.0262839488126275	0.0259043038450910	0.0255269271616695	0.0251517769668860	0.0247788118517248	0.0244079907883284	0.0240392731250156	0.0236726185816607	0.0233079872454796	0.0229453395672721	0.0225846363581835	0.0222258387870531	0.0218689083784313	0.0215138070113571	0.0211604969190056	0.0208089406893264	0.0204591012668194	0.0201109419556123	0.0197644264240306	0.0194195187108811	0.0190761832337047	0.0187343847992910	0.0183940886167949	0.0180552603138474	0.0177178659561116	0.0173818720708057	0.0170472456747961	0.0167139543079535	0.0163819660725734	0.0160512496797864	0.0157217745040247	0.0153935106467741	0.0150664290110326	0.0147405013881129	0.0144157005586772	0.0140920004101864	0.0137693760732757	0.0134478040799597	0.0131272625470123	0.0128077313883825	0.0124891925610998	0.0121716303498070	0.0118550316958470	0.0115393865777413	0.0112246884509466	0.0109109347559892	0.0105981275054723	0.0102862739620650	0.00997538742143913	0.00966548811626855	0.00935660425987531	0.00904877325096660	0.00874204306419475	0.00843647385507417	0.00813213981216893	0.00782913129452053	0.00752755729811544	0.00722754830191906	0.00692925955176054	0.00663287484930590	0.00633860534119218	0.00604668208898836	0.00575734718092017	0.00547084315742059	0.00518740048787110	0.00490722279591070	0.00463046948459446	0.00435723535953436	0.00408752678685538	0.00382129827619430	0.00355850492415222	0.00329910240672063	0.00304304697180593	0.00279029543184977	0.00254080515654470	0.00229453406564418	0.00205144062186486	0.00181148382388113	0.00157462319940918	0.00134081879838079	0.00111003118620559	0.000882221437119171	0.000657351127618361	0.000435382329980096	0.000216277605864399    
    ]; % dla D = 250

% Kuj = [
%     0.110767717394644	0.113164839563703	0.115547375615885	0.117913338000950	0.120261054455262	0.122589125375989	0.124896386878188	0.127181878778138	0.129444816847014	0.131684568766345	0.133900633292333	0.136092622201776	0.138260244649195	0.140403293614085	0.142521634159936	0.144615193263754	0.146683951006910	0.148727932945995	0.150477519571521	0.151716155479731	0.152515447092769	0.152937422144636	0.153035805413575	0.152857124618559	0.152441669088916	0.151824320806333	0.151035274809383	0.150100663688980	0.149043098942459	0.147882140254335	0.146634702298391	0.145315407378464	0.143936891118094	0.142510067449358	0.141044358319154	0.139547892809906	0.138027679746390	0.136489757318354	0.134939322778721	0.133380844869828	0.131818161277070	0.130254563103213	0.128692868091280	0.127135484093919	0.125584464087718	0.124041553858114	0.122508233330667	0.120985752394586	0.119475161951782	0.117977340827104	0.116493019090807	0.115022798270921	0.113567168869621	0.112126525542561	0.110701180252350	0.109291373665922	0.107897285029649	0.106519040724895	0.105156721679750	0.103810369789269	0.102479993476266	0.101165572507142	0.0998670621619738	0.0985843968448878	0.0973174932092885	0.0960662528625831	0.0948305647064377	0.0936103069611427	0.0924053489161931	0.0912155524435884	0.0900407733054919	0.0888808622836805	0.0877356661545607	0.0866050285303626	0.0854887905843786	0.0843867916757339	0.0832988698871135	0.0822248624870851	0.0811646063271024	0.0801179381819349	0.0790846950411029	0.0780647143578873	0.0770578342616086	0.0760638937381120	0.0750827327827345	0.0741141925294653	0.0731581153595109	0.0722143449920503	0.0712827265595968	0.0703631066700562	0.0694553334572948	0.0685592566217896	0.0676747274627213	0.0668015989026902	0.0659397255060760	0.0650889634919290	0.0642491707421589	0.0634202068056846	0.0626019328991229	0.0617942119045126	0.0609969083645063	0.0602098884754043	0.0594330200783527	0.0586661726489863	0.0579092172857594	0.0571620266971720	0.0564244751880746	0.0556964386452069	0.0549777945221064	0.0542684218235034	0.0535682010893035	0.0528770143782446	0.0521947452513035	0.0515212787549167	0.0508565014040710	0.0502003011653116	0.0495525674397091	0.0489131910458206	0.0482820642026742	0.0476590805128044	0.0470441349453584	0.0464371238192931	0.0458379447866783	0.0452464968161199	0.0446626801763134	0.0440863964197377	0.0435175483664972	0.0429560400883177	0.0424017768927026	0.0418546653072518	0.0413146130641491	0.0407815290848179	0.0402553234647493	0.0397359074585023	0.0392231934648778	0.0387170950122676	0.0382175267441757	0.0377244044049150	0.0372376448254766	0.0367571659095717	0.0362828866198454	0.0358147269642609	0.0353526079826531	0.0348964517334499	0.0344461812805608	0.0340017206804296	0.0335629949692513	0.0331299301503504	0.0327024531817196	0.0322804919637171	0.0318639753269200	0.0314528330201334	0.0310469956985520	0.0306463949120742	0.0302509630937642	0.0298606335484638	0.0294753404415487	0.0290950187878304	0.0287196044406000	0.0283490340808124	0.0279832452064106	0.0276221761217867	0.0272657659273788	0.0269139545094009	0.0265666825297069	0.0262238914157828	0.0258855233508702	0.0255515212642152	0.0252218288214438	0.0248963904150615	0.0245751511550748	0.0242580568597339	0.0239450540463952	0.0236360899225006	0.0233311123766740	0.0230300699699325	0.0227329119270106	0.0224395881277965	0.0221500490988790	0.0218642460052031	0.0215821306418337	0.0213036554258251	0.0210287733881955	0.0207574381660056	0.0204896039945381	0.0202252256995797	0.0199642586898013	0.0197066589492374	0.0194523830298624	0.0192013880442616	0.0189536316583989	0.0187090720844759	0.0184676680738834	0.0182293789102451	0.0179941644025497	0.0177619848783721	0.0175328011771823	0.0173065746437404	0.0170832671215766	0.0168628409465556	0.0166452589405243	0.0164304844050408	0.0162184811151850	0.0160092133134483	0.0158026457037030	0.0155987434452489	0.0153974721469368	0.0151987978613683	0.0150026870791693	0.0148091067233392	0.0146180241436712	0.0144294071112457	0.0142432238129941	0.0140594428463335	0.0138780332138696	0.0136989643181694	0.0135222059565995	0.0133477283162328	0.0131755019688196	0.0130054978658242	0.0128376873335255	0.0126720420681808	0.0125085341312517	0.0123471359446922	0.0121878202862971	0.0120305602851105	0.0118753294168936	0.0117221014996512	0.0115708506892155	0.0114215514748872	0.0112741786751326	0.0111287074333367	0.0109851132136103	0.0108433717966521	0.0107034592756635	0.0105653520523162	0.0104290268327725	0.0102944606237561	0.0101616307286738	0.0100305147437878	0.00990109055443649	0.00977333633130504	0.00964723052674315	0.00952275187113066	0.00939987936929061	0.00927859229694738	0.00915887019723196	0.00904069287723116	0.00892404040458181	0.00880889310410900	0.00869456303485913	0.00858103685973484	0.00846830137753087	0.00835634352075444	0.00824515035347470	0.00813470906920319	0.00802500698880519	0.00791603155844391	0.00780777034755794	0.00770021104687499	0.00759334146646235	0.00748714953381682	0.00738162329199732	0.00727675089780272	0.00717252061999855	0.00706892083759743	0.00696594003819720	0.00686356681638408	0.00676178987220638	0.00666059800972648	0.00655998013566155	0.00645992525812257	0.00636042248546363	0.00626146102525703	0.00616303018340900	0.00606511936343616	0.00596771806592443	0.00587081588819528	0.00577440252420924	0.00567846776474034	0.00558300149786044	0.00548799370977932	0.00539343448609120	0.00529931401348991	0.00520562258202060	0.00511235058794919	0.00501948853734142	0.00492702705045949	0.00483495686709854	0.00474326885300575	0.00465195400754657	0.00456100347280689	0.00447040854435051	0.00438016068388391	0.00429025153411934	0.00420067293617178	0.00411141694987763	0.00402247587748200	0.00393384229120961	0.00384550906531493	0.00375746941329726	0.00366971693107283	0.00358224564701637	0.00349505007992644	0.00340812530612964	0.00332146703712559	0.00323507170939008	0.00314893658820226	0.00306305988764803	0.00297744090928294	0.00289208020231807	0.00280697974863390	0.00272214317643260	0.00263757600692673	0.00255328593913572	0.00246928317864170	0.00238558081705372	0.00230219526996713	0.00221914678239946	0.00213646001206453	0.00205416470243681	0.00197229645939405	0.00189089764734337	0.00181001842317891	0.00172971640585352	0.00165005464882538	0.00157109921457255	0.00149291628897389	0.00141556876388788	0.00133911220534674	0.00126359011220635	0.00118902835558711	0.00111542867271529	0.00104277864990931	0.000971066033662070	0.000900278728573910	0.000830404795312729	0.000761432448600202	0.000693350055223907	0.000626146132075441	0.000559809344213295	0.000494328502951379	0.000429692563971643	0.000365890625461360	0.000302911926274331	0.000240745844116141	0.000179381893752192	0.000118809725239334	5.90191221801549e-05
%     ]; % dla D = 350

Ke = 0.995751757980348;


D = 250;




yzad(101:end) = 30;

for chwila = 101:1000
    
    y(chwila) = obiekt_aproksymacja(chwila, u, y);

    e = yzad(chwila) - (y(chwila)+Y0);

    du = dmc_online(chwila, u, e, Ke, Kuj, D);

    nowe_u = u(chwila-1)+ du;

    u(chwila) = min(50, max(nowe_u, -50));

    

end


figure;
stairs(y+Y0);
figure;
stairs(u);



function delta_u = dmc_online(k, u, e, Ke, Kuj, D)

    sum = 0;
    for j =1:D-1
        du_kmj = u(max(1, k-j)) - u(max(1, k-j-1));
        sum = sum + Kuj(j)*du_kmj;
    end

    delta_u = Ke*e - sum;

end
